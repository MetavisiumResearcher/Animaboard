<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <title>Animaboard</title>
  <link rel="icon" type="image/png" sizes="64x64" href="favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">
  <style>
    body { 
      background:#000; 
      color:#0f0; 
      font-family:monospace; 
      text-align:center; 
      padding:8px; 
      font-size:14px;
      margin: 0;
    }
    #header { 
      display: flex; 
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px; 
      padding: 0 10px;
    }
    #title-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #title {
      font-size: 18px;
      margin: 0;
      color: #00CED1;
    }
    #creator {
      font-size: 10px;
      color: #00CED1;
      margin: 2px 0 0 0;
    }
    #boxBtn { 
      background:#00CED1; 
      color:#000; 
      border:1px solid #000; 
      padding:6px 10px; 
      border-radius:4px; 
      font-size:12px; 
      cursor:pointer; 
    }
    textarea { 
      width:100%; 
      height:100px; 
      background:#111; 
      color:#0f0; 
      border:1px solid #0f0; 
      padding:6px; 
      font-size:14px; 
      box-sizing: border-box;
      margin-bottom: 8px;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    .keys { 
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    .keys button { 
      background:#111; 
      color:#0f0; 
      border:1px solid #0f0; 
      padding:8px 4px; 
      border-radius:4px; 
      font-size:12px; 
      cursor:pointer; 
      outline:none; 
      user-select:none; 
      -webkit-tap-highlight-color: transparent;
      transition: background 0.2s, color 0.2s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      touch-action: none;
    }
    .keys button.active { 
      background: #00CED1;
      color: #000; 
    }
    .keys button:disabled { color:#333; border-color:#333; cursor:default; }
    #readBtn {
      background: #FFA500;
      color: #000;
      border:1px solid #FFA500;
      font-size: 10px;
      padding: 6px 2px;
    }
    button { 
      margin:3px 2px;
      padding:4px 6px; 
      border-radius:4px; 
      cursor:pointer; 
      background:#111; 
      color:#0f0; 
      border:1px solid #0f0; 
      font-size:12px;
      white-space: nowrap;
      touch-action: manipulation;
    }
    .control-row { 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      gap: 6px; 
      margin-bottom: 8px; 
    }
    .scan-mode { 
      display: flex; 
      gap: 4px; 
      justify-content: center; 
      margin-bottom: 8px; 
    }
    .scan-mode button {
      background:#111; 
      color:#0f0; 
      border:1px solid #0f0; 
      padding:6px 10px; 
      border-radius:4px; 
      font-size:12px; 
      cursor:pointer;
      touch-action: manipulation;
    }
    .scan-mode button.active { 
      background: #00CED1;
      color: #000; 
      border:1px solid #00CED1; 
    }
    #delayContainer, #speedContainer { 
      margin-top:5px; 
      color:#0f0; 
      font-size:12px; 
      display: flex; 
      align-items: center; 
      gap: 6px; 
    }
    input[type=range] { 
      width:100%; 
      margin: 0; 
      touch-action: manipulation;
    }
    #savedMessages { 
      display: none; 
      position: fixed; 
      top: 0; left: 0; right: 0; bottom: 0; 
      background: #111; 
      padding: 20px; 
      overflow-y: auto; 
      z-index: 1000; 
    }
    #savedMessages h3 { color: #00CED1; text-align: center; }
    .message-item { 
      background: #222; 
      padding: 10px; 
      margin: 10px 0; 
      border-left: 3px solid #00CED1; 
      text-align: left;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .close-btn { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      background: #f00; 
      color: white; 
      border: none; 
      padding: 5px 10px; 
      border-radius: 4px; 
      cursor: pointer; 
      touch-action: manipulation;
    }
    .box-actions {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      justify-content: center;
    }
    .box-actions button {
      padding: 8px 16px;
      font-size: 14px;
      touch-action: manipulation;
    }
    #saveBtn { background: #00CED1; color: #000; }
    #clearBtn { background: #f00; color: white; }

    /* Stile per pulsante Campo EM */
    #emModeBtn {
      background: #4B0082;
      color: white;
      border: 1px solid #4B0082;
    }
    #emModeBtn.active {
      background: #00FFFF;
      color: #000;
      border-color: #00FFFF;
    }

    /* Fallback video */
    video[style*="opacity: 0.01"] {
      display: block !important;
      visibility: visible !important;
    }
  </style>
</head>
<body>

  <div id="header">
    <div id="title-container">
      <h1 id="title">Animaboard</h1>
      <p id="creator">Created By Domenico Pizzurro</p>
    </div>
    <button id="boxBtn">üìÅ Box</button>
  </div>

  <textarea 
    id="box" 
    placeholder="In Attesa Di Un Messaggio...."
    readonly
    onfocus="this.blur()"
  ></textarea>

  <div class="scan-mode">
    <button id="scanModeAll" class="active">Tutto</button>
    <button id="scanModeLetters">Solo Lettere</button>
    <button id="scanModeNumbers">Solo Numeri</button>
  </div>

  <div class="keys" id="keys"></div>

  <div class="control-row">
    <button id="wakeBtn">Schermo: OFF</button>
    <button id="scanBtn">‚ñ∂Ô∏è Avvia Scansione</button>
    <button id="emModeBtn">üì° Campo EM</button>
  </div>

  <div id="delayContainer">
    <label for="letterDelay">Delay:</label>
    <input type="range" id="letterDelay" min="100" max="6000" step="50" value="500">
    <span id="letterDelayValue">500</span>ms
  </div>

  <div id="speedContainer">
    <label for="scanSpeed">Velocit√†:</label>
    <input type="range" id="scanSpeed" min="100" max="6000" step="50" value="500">
    <span id="scanSpeedValue">500</span>ms
  </div>

  <div id="savedMessages">
    <h3>üìÅ Messaggi Salvati</h3>
    <div class="box-actions">
      <button id="saveBtn">üíæ Salva su File</button>
      <button id="clearBtn">üóëÔ∏è Cancella Tutto</button>
    </div>
    <div id="messagesList"></div>
    <button class="close-btn">Chiudi</button>
  </div>

  <script>
    const box = document.getElementById("box");
    const keysContainer = document.getElementById("keys");
    const wakeBtn = document.getElementById("wakeBtn");
    const scanBtn = document.getElementById("scanBtn");
    const letterDelaySlider = document.getElementById("letterDelay");
    const letterDelayValue = document.getElementById("letterDelayValue");
    const scanSpeedSlider = document.getElementById("scanSpeed");
    const scanSpeedValue = document.getElementById("scanSpeedValue");
    const boxBtn = document.getElementById("boxBtn");
    const savedMessages = document.getElementById("savedMessages");
    const messagesList = document.getElementById("messagesList");
    const scanModeAll = document.getElementById("scanModeAll");
    const scanModeLetters = document.getElementById("scanModeLetters");
    const scanModeNumbers = document.getElementById("scanModeNumbers");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const emModeBtn = document.getElementById("emModeBtn");

    let letterDelay = parseInt(letterDelaySlider.value);
    let scanSpeed = parseInt(scanSpeedSlider.value);
    let scanActive = false;
    let scanTimer = null;
    let scanMode = 'all';
    let currentActiveButton = null;
    let filteredIndex = 0;
    let lastFullMessage = "";
    let hasSavedOnFirstDelete = false;
    let lastSavedMessage = "";

    // ‚úÖ Variabili per Campo EM Audio
    let emModeActive = false;
    let emAudioContext = null;
    let emAnalyser = null;
    let emData = null;
    let emBaseline = 0;
    let emSamples = [];
    const emSampleSize = 50;
    const emTriggerMultiplier = 2.5;

    // ‚úÖ Funzione Text-to-Speech
    function speak(text, rate = 1.0, pitch = 1.0, isSpirit = false) {
      if (!('speechSynthesis' in window)) {
        console.warn("SpeechSynthesis non supportato.");
        return;
      }

      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'it-IT';
      utterance.rate = rate;
      utterance.pitch = pitch;
      utterance.volume = 1.0;

      let voices = window.speechSynthesis.getVoices();
      let italianVoices = voices.filter(v => v.lang.startsWith('it'));

      if (isSpirit) {
        utterance.rate = 0.7;
        utterance.pitch = 1.8;
        let spiritVoice = italianVoices.find(v => /whisper|soft|delicate|femminile/i.test(v.name)) || 
                         voices.find(v => /whisper|soft/i.test(v.name)) || 
                         italianVoices[0] || voices[0];
        if (spiritVoice) utterance.voice = spiritVoice;
      } else {
        let maleVoice = italianVoices.find(v => /male|uomo|man/i.test(v.name)) || italianVoices[0] || voices.find(v => /male/i.test(v.name)) || null;
        if (maleVoice) utterance.voice = maleVoice;
      }

      window.speechSynthesis.speak(utterance);

      if (voices.length === 0) {
        window.speechSynthesis.onvoiceschanged = () => {
          voices = window.speechSynthesis.getVoices();
          italianVoices = voices.filter(v => v.lang.startsWith('it'));
          if (isSpirit) {
            let spiritVoice = italianVoices.find(v => /whisper|soft/i.test(v.name)) || italianVoices[0] || voices[0];
            if (spiritVoice) utterance.voice = spiritVoice;
          } else {
            let maleVoice = italianVoices.find(v => /male|uomo|man/i.test(v.name)) || italianVoices[0] || voices.find(v => /male/i.test(v.name)) || null;
            if (maleVoice) utterance.voice = maleVoice;
          }
          window.speechSynthesis.speak(utterance);
        };
      }
    }

    // Modalit√† di scansione
    function setScanMode(mode) {
      scanMode = mode;
      [scanModeAll, scanModeLetters, scanModeNumbers].forEach(btn => btn.classList.remove('active'));
      if (mode === 'all') scanModeAll.classList.add('active');
      if (mode === 'letters') scanModeLetters.classList.add('active');
      if (mode === 'numbers') scanModeNumbers.classList.add('active');
    }

    scanModeAll.addEventListener('click', () => setScanMode('all'));
    scanModeLetters.addEventListener('click', () => setScanMode('letters'));
    scanModeNumbers.addEventListener('click', () => setScanMode('numbers'));

    letterDelaySlider.addEventListener("input", ()=>{
      letterDelay = parseInt(letterDelaySlider.value);
      letterDelayValue.textContent = letterDelay;
    });

    scanSpeedSlider.addEventListener("input", ()=>{
      scanSpeed = parseInt(scanSpeedSlider.value);
      scanSpeedValue.textContent = scanSpeed;
      if(scanActive){ startScan(); }
    });

    // Genera tastiera
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const numbers = "0123456789".split("");
    const special = ["Spazio", "Cancella"];
    const allKeys = [...letters, ...numbers, ...special];
    const keyButtons = [];

    allKeys.forEach(l=>{
      const btn = document.createElement("button");
      btn.textContent = l;
      btn.dataset.letter = l;
      keysContainer.appendChild(btn);
      keyButtons.push(btn);
    });

    // ‚úÖ Bottone Leggi
    const readBtn = document.createElement("button");
    readBtn.id = "readBtn";
    readBtn.textContent = "üîä Leggi";
    keysContainer.appendChild(readBtn);

    readBtn.addEventListener("click", () => {
      if (box.value.trim() !== "") {
        speak(box.value, 0.9, 1.1);
      } else {
        speak("Nessun testo da leggere.");
      }
    });

    // ‚úÖ SCRITTURA
    function writeLetter(l){
      if(l==="Spazio") {
        box.value += " ";
        speak("Spazio");
        lastFullMessage = box.value;
        hasSavedOnFirstDelete = false;
      }
      else if(l==="Cancella") {
        if (box.value.length > 0) {
          if (!hasSavedOnFirstDelete) {
            if (lastFullMessage.trim() !== "" && lastFullMessage !== lastSavedMessage) {
              saveMessageWithSignature(lastFullMessage);
            }
            hasSavedOnFirstDelete = true;
          }
          let currentValue = box.value;
          let newValue = currentValue.slice(0, -1);
          box.value = newValue;
        }
      }
      else {
        box.value += l;
        speak(l);
        lastFullMessage = box.value;
        hasSavedOnFirstDelete = false;
      }

      setTimeout(() => {
        box.scrollTop = box.scrollHeight;
      }, 0);
    }

    // ‚úÖ Salva messaggio con firma energetica
    function saveMessageWithSignature(message, isSpirit = false) {
      const saved = JSON.parse(localStorage.getItem('animaboard_messages') || '[]');
      const now = new Date();
      const timestamp = now.toLocaleString('it-IT');
      const energySignature = Date.now() % 10000;
      saved.push({ 
        timestamp, 
        message, 
        energySignature,
        isSpirit
      });
      localStorage.setItem('animaboard_messages', JSON.stringify(saved));
      lastSavedMessage = message;
    }

    // ‚úÖ Gestione click/touch su "Cancella"
    keyButtons.forEach(btn=>{
      if(btn.dataset.letter === "Cancella"){
        btn.addEventListener("mousedown", handleDeleteClick);
        btn.addEventListener("touchstart", handleDeleteClick);
      }
    });

    function handleDeleteClick(e) {
      e.preventDefault();
      
      const longPressTimer = setTimeout(() => {
        if (lastFullMessage.trim() !== "" && lastFullMessage !== lastSavedMessage) {
          saveMessageWithSignature(lastFullMessage);
        }
        box.value = "";
        lastFullMessage = "";
        hasSavedOnFirstDelete = false;
      }, 600);

      const cancelLongPress = () => {
        clearTimeout(longPressTimer);
      };

      const events = ['mouseup', 'mouseleave', 'touchend', 'touchcancel'];
      events.forEach(event => {
        document.addEventListener(event, cancelLongPress, { once: true });
      });
    }

    // ‚úÖ Evidenzia tasto
    function updateScanHighlight(){
      keyButtons.forEach(btn => btn.classList.remove('active'));
      
      let filteredButtons = keyButtons.filter(btn => btn !== readBtn);
      if (scanMode === 'letters') {
        filteredButtons = filteredButtons.filter(btn => letters.includes(btn.dataset.letter));
      } else if (scanMode === 'numbers') {
        filteredButtons = filteredButtons.filter(btn => numbers.includes(btn.dataset.letter));
      }

      if (filteredButtons.length === 0) {
        currentActiveButton = null;
        return;
      }

      const currentButton = filteredButtons[filteredIndex];
      if (currentButton && currentButton.dataset.letter !== "Cancella") {
        currentButton.classList.add('active');
        currentActiveButton = currentButton;
      }

      let nextIndex = filteredIndex;
      let validButtonFound = false;
      do {
        nextIndex = (nextIndex + 1) % filteredButtons.length;
        const btn = filteredButtons[nextIndex];
        if (btn && btn.dataset.letter !== "Cancella") {
          filteredIndex = nextIndex;
          validButtonFound = true;
          break;
        }
      } while (nextIndex !== filteredIndex);
    }

    // ‚úÖ Avvia scansione
    function startScan(){
      if(scanTimer) clearInterval(scanTimer);

      let filteredButtons = keyButtons.filter(btn => btn !== readBtn);
      if (scanMode === 'letters') {
        filteredButtons = filteredButtons.filter(btn => letters.includes(btn.dataset.letter));
      } else if (scanMode === 'numbers') {
        filteredButtons = filteredButtons.filter(btn => numbers.includes(btn.dataset.letter));
      }

      filteredIndex = 0;
      let found = false;
      for (let i = 0; i < filteredButtons.length; i++) {
        if (filteredButtons[i].dataset.letter !== "Cancella") {
          filteredIndex = i;
          found = true;
          break;
        }
      }

      if (!found && filteredButtons.length > 0) {
        filteredIndex = 0;
      }

      updateScanHighlight();
      scanTimer = setInterval(updateScanHighlight, scanSpeed);

      // ‚úÖ ATTIVA TOUCH SUPERSENSIBILE OVUNQUE ‚Äî SOLO IN SCANSIONE
      document.addEventListener('touchstart', handleGlobalTouch, { passive: false });
      document.addEventListener('click', handleGlobalTouch, { passive: false });
    }

    // ‚úÖ NUOVA FUNZIONE: Touch Supersensibile ‚Äî ovunque sullo schermo
    function handleGlobalTouch(e) {
      if (!scanActive || !currentActiveButton) return;

      // ‚úÖ TOCCO OVUNQUE ‚Üí SCRIVE LETTERA EVIDENZIATA
      e.preventDefault();
      writeLetter(currentActiveButton.dataset.letter);
    }

    // ‚úÖ Ferma scansione
    function stopScan() {
      clearInterval(scanTimer);
      scanTimer = null;
      keyButtons.forEach(btn => btn.classList.remove('active'));
      readBtn.classList.remove('active');

      // ‚úÖ RIMUOVI LISTENER TOUCH GLOBALE
      document.removeEventListener('touchstart', handleGlobalTouch);
      document.removeEventListener('click', handleGlobalTouch);
    }

    scanBtn.addEventListener("click", ()=>{
      scanActive = !scanActive;
      scanBtn.textContent = scanActive ? "‚èπ Ferma Scansione" : "‚ñ∂Ô∏è Avvia Scansione";
      if(scanActive){
        startScan();
      } else {
        stopScan();
      }
    });

    // ==================================================
    // TOUCH LOGICA ESISTENTE (solo per uso fuori scansione)
    // ==================================================
    let lastTouchedKey = null;

    function handleTouchStart(e) {
      if (scanActive) return; // ‚úÖ In scansione, gestito da handleGlobalTouch
      handleTouchLogic(e, true);
    }

    function handleTouchMove(e) {
      if (!scanActive) {
        handleTouchLogic(e, false);
      } else {
        e.preventDefault();
        if (currentActiveButton) {
          writeLetter(currentActiveButton.dataset.letter);
        }
      }
    }

    function handleTouchEnd() {
      lastTouchedKey = null;
    }

    function handleTouchLogic(e, isStart) {
      if (scanActive) return; // ‚úÖ In scansione, non serve

      const excludedSelectors = [
        'input[type="range"]',
        '#wakeBtn',
        '#scanBtn',
        '#boxBtn',
        '.scan-mode button',
        '.close-btn',
        '#saveBtn',
        '#clearBtn',
        '#emModeBtn'
      ];

      for (let selector of excludedSelectors) {
        if (e.target.closest(selector)) {
          return;
        }
      }

      e.preventDefault();

      for (let i = 0; i < e.touches.length; i++) {
        const touch = e.touches[i];
        const el = document.elementFromPoint(touch.clientX, touch.clientY);
        const btn = el?.closest('button[data-letter], #readBtn');

        if (!btn) continue;

        if (btn !== lastTouchedKey) {
          if (btn.id === "readBtn") {
            if (box.value.trim() !== "") {
              speak(box.value, 0.9, 1.1);
            } else {
              speak("Nessun testo da leggere.");
            }
          } else {
            writeLetter(btn.dataset.letter);
          }
          lastTouchedKey = btn;
        }
      }
    }

    document.addEventListener("touchstart", handleTouchStart, { passive: false });
    document.addEventListener("touchmove", handleTouchMove, { passive: false });
    document.addEventListener("touchend", handleTouchEnd, { passive: false });
    document.addEventListener("touchcancel", handleTouchEnd, { passive: false });

    document.querySelectorAll('button[data-letter]').forEach(btn => {
      if (btn.dataset.letter !== "Cancella") {
        btn.addEventListener('click', () => {
          if (!scanActive) {
            writeLetter(btn.dataset.letter);
          } else if (btn.classList.contains('active')) {
            writeLetter(btn.dataset.letter);
          }
        });
      }
    });

    // ‚úÖ Pulsante Box
    boxBtn.addEventListener("click", () => {
      if (box.value.trim() !== "" && box.value !== lastSavedMessage) {
        saveMessageWithSignature(box.value);
      }
      showSavedMessages();
    });

    function showSavedMessages() {
      messagesList.innerHTML = '';
      const saved = JSON.parse(localStorage.getItem('animaboard_messages') || '[]');
      
      if (saved.length === 0) {
        messagesList.innerHTML = '<p style="color:#0f0;">Nessun messaggio salvato</p>';
      } else {
        saved.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'message-item';
          let signatureClass = item.isSpirit ? 'energy-signature spirit' : 'energy-signature';
          div.innerHTML = `
            <strong>${item.timestamp}</strong> 
            ${item.isSpirit ? '<span style="color:#FF1493">[Anima]</span>' : ''}
            <br>
            ${item.message.replace(/\n/g, '<br>')}
            <div class="${signatureClass}">Firma: ${item.energySignature}</div>
          `;
          messagesList.appendChild(div);
        });
      }
      
      savedMessages.style.display = 'block';
    }

    saveBtn.addEventListener("click", () => {
      const saved = JSON.parse(localStorage.getItem('animaboard_messages') || '[]');
      if (saved.length === 0) {
        alert("Nessun messaggio da salvare!");
        return;
      }
      
      let content = "";
      saved.forEach(item => {
        content += `[${item.timestamp}] ${item.isSpirit ? '[ANIMA] ' : ''}\n${item.message}\nFirma Energetica: ${item.energySignature}\n\n---\n\n`;
      });
      
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'animaboard_messaggi_' + new Date().toISOString().slice(0,10) + '.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    clearBtn.addEventListener("click", () => {
      if (confirm("Sei sicuro di voler cancellare TUTTI i messaggi salvati?")) {
        localStorage.removeItem('animaboard_messages');
        lastSavedMessage = "";
        showSavedMessages();
        alert("Tutti i messaggi sono stati cancellati.");
      }
    });

    document.querySelector('.close-btn').addEventListener('click', () => {
      savedMessages.style.display = 'none';
    });

    // Schermo sempre acceso
    let wakeLock = null;
    let wakeActive = false;
    let wakeVideo = null;

    async function toggleWakeLock() {
      if (wakeActive) {
        if (wakeLock) {
          try { await wakeLock.release(); } catch (e) {}
          wakeLock = null;
        }
        if (wakeVideo) {
          wakeVideo.pause();
          wakeVideo.src = '';
          wakeVideo.remove();
          wakeVideo = null;
        }
        wakeActive = false;
        wakeBtn.textContent = "Schermo: OFF";
        console.log("üì¥ Schermo sbloccato");
      } else {
        if ('wakeLock' in navigator) {
          try {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeActive = true;
            wakeBtn.textContent = "Schermo: ON (WakeLock)";
            console.log("‚úÖ Wake Lock attivato");
            return;
          } catch (err) {
            console.warn("Wake Lock non disponibile, passo al fallback video:", err);
          }
        }

        try {
          wakeVideo = document.createElement('video');
          wakeVideo.style.position = 'fixed';
          wakeVideo.style.top = '0';
          wakeVideo.style.left = '0';
          wakeVideo.style.width = '1px';
          wakeVideo.style.height = '1px';
          wakeVideo.style.opacity = '0.01';
          wakeVideo.style.pointerEvents = 'none';
          wakeVideo.style.zIndex = '-9999';
          wakeVideo.muted = true;
          wakeVideo.loop = true;
          wakeVideo.playsInline = true;
          wakeVideo.disableRemotePlayback = true;

          const canvas = document.createElement('canvas');
          canvas.width = 1;
          canvas.height = 1;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#000';
          ctx.fillRect(0, 0, 1, 1);
          const stream = canvas.captureStream(1);

          wakeVideo.srcObject = stream;
          document.body.appendChild(wakeVideo);

          await wakeVideo.play();
          wakeActive = true;
          wakeBtn.textContent = "Schermo: ON (WakeLock)";
          console.log("‚úÖ Fallback video attivato");

        } catch (err) {
          console.error("‚ùå Impossibile attivare nemmeno il fallback video:", err);
          wakeBtn.textContent = "Schermo: ERRORE";
          alert("Impossibile bloccare lo schermo. Prova su un altro browser o dispositivo.");
        }
      }
    }

    wakeBtn.addEventListener("click", (e) => {
      toggleWakeLock();
    });

    // ‚úÖ MODALIT√Ä CAMPO EM (SOLO INTERFERENZE)
    async function startEMMode() {
      if (emModeActive) return;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        emAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        emAnalyser = emAudioContext.createAnalyser();
        emAnalyser.fftSize = 256;
        const source = emAudioContext.createMediaStreamSource(stream);
        source.connect(emAnalyser);
        emData = new Uint8Array(emAnalyser.frequencyBinCount);

        emModeActive = true;
        emModeBtn.classList.add('active');
        emModeBtn.textContent = "üì° EM ATTIVO";

        setInterval(() => {
          if (!emModeActive || !currentActiveButton) return;

          emAnalyser.getByteFrequencyData(emData);
          const avg = emData.reduce((a, b) => a + b, 0) / emData.length;

          emSamples.push(avg);
          if (emSamples.length > emSampleSize) emSamples.shift();
          emBaseline = emSamples.reduce((a, b) => a + b, 0) / emSamples.length;

          // ‚úÖ SCRIVE SOLO SE C'√à UNA VERA INTERFERENZA EM
          if (avg > emBaseline * emTriggerMultiplier && avg > 30) {
            writeLetter(currentActiveButton.dataset.letter);
            speak("Interferenza EM rilevata", 0.7, 1.6, true);
          }
        }, 50);

      } catch (err) {
        alert("Permesso microfono negato. Attiva da Impostazioni.");
        console.error(err);
      }
    }

    function stopEMMode() {
      emModeActive = false;
      emModeBtn.classList.remove('active');
      emModeBtn.textContent = "üì° Campo EM";
      if (emAudioContext) {
        emAudioContext.close();
        emAudioContext = null;
      }
    }

    emModeBtn.addEventListener('click', () => {
      if (!emModeActive) {
        startEMMode();
      } else {
        stopEMMode();
      }
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => {
            console.log('‚úÖ Animaboard: Service Worker registrato con successo:', reg.scope);
          })
          .catch(err => {
            console.error('‚ùå Animaboard: Registrazione Service Worker fallita:', err);
          });
      });
    }
  </script>

</body>
</html>
